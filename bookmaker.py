#+
# Blender add-on script to generate a random row of books.
#-

import math
import bpy

bl_info = \
    {
        "name" : "Bookmaker",
        "author" : "Lawrence D'Oliveiro <ldo@geek-central.gen.nz>",
        "version" : (0, 1, 0),
        "blender" : (2, 7, 9),
        "location" : "Add > Mesh > Books",
        "description" :
            "generates a row of book objects with randomly-distributed parameters.",
        "warning" : "",
        "wiki_url" : "",
        "tracker_url" : "",
        "category" : "Add Mesh",
    }

#+
# Useful stuff
#-

class Failure(Exception) :

    def __init__(self, msg) :
        self.msg = msg
    #end __init__

#end Failure

#+
# Book mesh
#-

book_mesh = \
    {
        "vertices" :
          [
            (1, 1.999999, 3),
            (1.02024, -1.997049, 3.007324),
            (-0.9878417, -1.997049, 3.007324),
            (-0.9999999, 2, 3),
            (1, 1.999999, 3.1),
            (-0.6902668, -2.041447, 3.007324),
            (-0.9999999, 2, 3.1),
            (1, 2.099999, 3.1),
            (-0.9999999, 2.1, 3.1),
            (-1.001419, -1.797197, -3.100269),
            (-0.9718257, -1.863814, -3.100538),
            (-0.9878417, -1.930432, -3.100807),
            (1, 2.099999, 3),
            (-0.9999999, 2.1, 3),
            (1.02024, -1.930432, -3.100807),
            (0.9934545, -1.863814, -3.100538),
            (1.000875, -1.797197, -3.100269),
            (0.9000005, 1.999999, 3.1),
            (0.8999993, -1.830432, 3.1),
            (0.9000005, 2.099999, 3.1),
            (-0.989868, -1.930432, -3.006104),
            (-0.9718257, -1.863814, -3.004883),
            (0.9000005, 2.099999, 3),
            (1.02024, -1.930432, -3.006104),
            (-0.9000003, -1.830432, 3.1),
            (-0.8999999, 2, 3.1),
            (-0.8999999, 2.1, 3.1),
            (0.9934545, -1.863814, -3.004883),
            (1.01012, -1.797197, -3.003662),
            (-0.8999999, 2.1, 3),
            (-0.9939208, -1.797197, -3.003662),
            (0.3492145, -2.172925, -3.007324),
            (0.02416586, -2.208633, -3.007324),
            (-0.3463206, -2.156489, -3.007324),
            (0.6717731, -2.059875, 3.007324),
            (0.3492145, -2.172925, 3.007324),
            (0.02416587, -2.208633, 3.007324),
            (-0.3463206, -2.156489, 3.007324),
            (0.6717731, -2.059875, -3.007324),
            (-0.8999999, 2.1, -3),
            (-0.8999999, 2.1, -3.1),
            (-0.8999999, 2, -3.1),
            (-0.9939208, -1.797197, 3.003662),
            (-0.9000003, -1.830432, -3.1),
            (1.01012, -1.797197, 3.003662),
            (0.9000005, 2.099999, -3),
            (0.9000005, 2.099999, -3.1),
            (0.9934545, -1.863814, 3.004883),
            (1.02024, -1.930432, 3.006104),
            (0.8999993, -1.830432, -3.1),
            (0.9000005, 1.999999, -3.1),
            (-0.9718257, -1.863814, 3.004883),
            (-0.989868, -1.930432, 3.006104),
            (1.000875, -1.797197, 3.100269),
            (0.9934545, -1.863814, 3.100538),
            (1.02024, -1.930432, 3.100807),
            (-0.9878417, -1.930432, 3.100807),
            (-0.9718257, -1.863814, 3.100538),
            (-1.001419, -1.797197, 3.100269),
            (-0.6902668, -2.041447, 3.101076),
            (-0.3463206, -2.156489, 3.101076),
            (0.02416586, -2.208633, 3.101076),
            (1.02024, -1.997049, 3.101076),
            (0.3492145, -2.172925, 3.101076),
            (0.6717731, -2.059875, 3.101076),
            (-0.9878417, -1.997049, 3.101076),
            (-0.6902668, -1.941447, 3.101076),
            (-0.3463206, -2.056489, 3.101076),
            (0.02416586, -2.108633, 3.101076),
            (0.3492145, -2.072925, 3.101076),
            (0.6717731, -1.959875, 3.101076),
            (-0.9999999, 2.1, -3),
            (1, 2.099999, -3),
            (-0.9999999, 2.1, -3.1),
            (1, 2.099999, -3.1),
            (-0.9999999, 2, -3.1),
            (-0.6902668, -2.041447, -3.007324),
            (1, 1.999999, -3.1),
            (-0.9999999, 2, -3),
            (-0.9878417, -1.997049, -3.007324),
            (1.02024, -1.997049, -3.007324),
            (1, 1.999999, -3),
            (-0.6902668, -1.941447, 3.005493),
            (-0.3463206, -2.056489, 3.005493),
            (0.02416586, -2.108633, 3.005493),
            (0.3492145, -2.072925, 3.005493),
            (0.6717731, -1.959875, 3.005493),
            (0.9092773, -1.866009, 3.094275),
            (-0.8888375, -1.866009, 3.094275),
            (0.9000005, 1.999999, 3.005493),
            (0.8999993, -1.830432, 3.005493),
            (-0.9000003, -1.830432, 3.005493),
            (-0.8999999, 2, 3.005493),
            (0.9092773, -1.866009, 3.005493),
            (-0.8888375, -1.866009, 3.005493),
            (-0.8995486, -1.93594, 3.100942),
            (0.9065011, -1.945153, 3.100942),
            (-0.8995486, -1.93594, 3.005493),
            (0.9065011, -1.945153, 3.005493),
            (0.5999994, -1.868652, 3.005493),
            (0.2999994, -1.958888, 3.005493),
            (-5.364418e-07, -1.958888, 3.005493),
            (-0.3000005, -1.958888, 3.005493),
            (-0.6000004, -1.868652, 3.005493),
            (-0.6902668, -2.041447, -3.101076),
            (-0.3463206, -2.156489, -3.101076),
            (0.02416586, -2.208633, -3.101076),
            (1.02024, -1.997049, -3.101076),
            (0.3492145, -2.172925, -3.101076),
            (0.6717731, -2.059875, -3.101076),
            (-0.9878417, -1.997049, -3.101076),
            (-0.6902668, -1.941447, -3.101076),
            (-0.3463206, -2.056489, -3.101076),
            (0.02416586, -2.108633, -3.101076),
            (0.3492145, -2.072925, -3.101076),
            (0.6717731, -1.959875, -3.101076),
            (-0.6902668, -1.941447, -3.005493),
            (-0.3463206, -2.056489, -3.005493),
            (0.02416586, -2.108633, -3.005493),
            (0.3492145, -2.072925, -3.005493),
            (0.6717731, -1.959875, -3.005493),
            (0.9092773, -1.866009, -3.094275),
            (-0.8888375, -1.866009, -3.094275),
            (0.9000005, 1.999999, -3.005493),
            (0.8999993, -1.830432, -3.005493),
            (-0.9000003, -1.830432, -3.005493),
            (-0.8999999, 2, -3.005493),
            (0.9092773, -1.866009, -3.005493),
            (-0.8888375, -1.866009, -3.005493),
            (-0.8995486, -1.93594, -3.100942),
            (0.9065011, -1.945153, -3.100942),
            (-0.8995486, -1.93594, -3.005493),
            (0.9065011, -1.945153, -3.005493),
            (0.5999994, -1.868652, -3.005493),
            (0.2999994, -1.958888, -3.005493),
            (-5.364418e-07, -1.958888, -3.005493),
            (-0.3000005, -1.958888, -3.005493),
            (-0.6000004, -1.868652, -3.005493),
          ],

        # "bounds" : ((min_x, max_x), (min_y, max_y), (min_z, max_z)) computed below

        "faces" :
          [
            [59, 60, 67, 66],
            [92, 91, 103, 102, 101, 100, 99, 90, 89],
            [42, 58, 6, 3],
            [51, 57, 58, 42],
            [112, 117, 118, 113],
            [4, 0, 12, 7],
            [114, 119, 120, 115],
            [74, 46, 45, 72],
            [104, 111, 112, 105],
            [111, 116, 117, 112],
            [105, 112, 113, 106],
            [3, 6, 8, 13],
            [104, 110, 11, 129, 111],
            [7, 12, 22, 19],
            [14, 23, 80, 107],
            [106, 113, 114, 108],
            [104, 76, 79, 110],
            [4, 7, 19, 17],
            [13, 8, 26, 29],
            [108, 114, 115, 109],
            [8, 6, 25, 26],
            [20, 11, 110, 79],
            [37, 60, 59, 5],
            [38, 31, 108, 109],
            [14, 15, 27, 23],
            [28, 16, 77, 81],
            [52, 56, 57, 51],
            [44, 0, 4, 53],
            [54, 47, 44, 53],
            [55, 48, 47, 54],
            [36, 61, 60, 37],
            [33, 37, 5, 76],
            [34, 64, 63, 35],
            [35, 63, 61, 36],
            [34, 1, 62, 64],
            [61, 63, 69, 68],
            [59, 65, 2, 5],
            [55, 62, 1, 48],
            [52, 2, 65, 56],
            [15, 16, 28, 27],
            [113, 118, 119, 114],
            [126, 123, 124, 133, 134, 135, 136, 137, 125],
            [30, 21, 51, 42],
            [41, 43, 9, 75],
            [109, 115, 130, 14, 107],
            [77, 74, 72, 81],
            [77, 50, 46, 74],
            [73, 40, 41, 75],
            [10, 9, 43, 122],
            [32, 33, 105, 106],
            [31, 32, 106, 108],
            [79, 76, 5, 2],
            [30, 78, 75, 9],
            [20, 79, 2, 52],
            [21, 20, 52, 51],
            [1, 80, 23, 48],
            [23, 27, 47, 48],
            [27, 28, 44, 47],
            [63, 64, 70, 69],
            [60, 61, 68, 67],
            [33, 76, 104, 105],
            [59, 66, 95, 56, 65],
            [64, 62, 55, 96, 70],
            [78, 71, 73, 75],
            [71, 39, 40, 73],
            [21, 30, 9, 10],
            [50, 77, 16, 49],
            [38, 109, 107, 80],
            [20, 21, 10, 11],
            [25, 6, 58, 24],
            [17, 18, 53, 4],
            [67, 68, 84, 83],
            [68, 69, 85, 84],
            [66, 67, 83, 82],
            [69, 70, 86, 85],
            [57, 88, 24, 58],
            [87, 54, 53, 18],
            [25, 24, 91, 92],
            [56, 95, 88, 57],
            [55, 54, 87, 96],
            [97, 95, 66, 82],
            [98, 86, 70, 96],
            [94, 88, 95, 97],
            [88, 94, 91, 24],
            [103, 91, 94, 97, 82],
            [85, 86, 99, 100],
            [84, 85, 100, 101],
            [83, 84, 101, 102],
            [82, 83, 102, 103],
            [22, 89, 17, 19],
            [26, 25, 92, 29],
            [121, 49, 16, 15],
            [41, 126, 125, 43],
            [49, 124, 123, 50],
            [11, 10, 122, 129],
            [14, 130, 121, 15],
            [131, 116, 111, 129],
            [132, 130, 115, 120],
            [49, 121, 127, 124],
            [128, 131, 129, 122],
            [122, 43, 125, 128],
            [137, 116, 131, 128, 125],
            [120, 133, 124, 127, 132],
            [119, 134, 133, 120],
            [118, 135, 134, 119],
            [117, 136, 135, 118],
            [116, 137, 136, 117],
            [45, 46, 50, 123],
            [40, 39, 126, 41],
            [92, 89, 123, 126],
            [3, 78, 30, 42],
            [3, 13, 71, 78],
            [13, 29, 39, 71],
            [92, 126, 39, 29],
            [22, 12, 72, 45],
            [12, 0, 81, 72],
            [127, 121, 130, 132],
            [93, 98, 96, 87],
            [87, 18, 90, 93],
            [98, 93, 90, 99, 86],
            [89, 22, 45, 123],
            [18, 17, 89, 90],
            [44, 28, 81, 0],
            [32, 36, 37, 33],
            [35, 36, 32, 31],
            [34, 35, 31, 38],
            [1, 34, 38, 80],
          ],

        "left_vertices" :
            {
                2,
                3,
                6,
                8,
                9,
                10,
                11,
                13,
                20,
                21,
                24,
                25,
                26,
                29,
                30,
                39,
                40,
                41,
                42,
                43,
                51,
                52,
                56,
                57,
                58,
                65,
                71,
                73,
                75,
                78,
                79,
                88,
                91,
                92,
                94,
                95,
                97,
                110,
                122,
                125,
                126,
                128,
                129,
                131,
            },

        "right_vertices" :
            {
                0,
                1,
                4,
                7,
                12,
                14,
                15,
                16,
                17,
                18,
                19,
                22,
                23,
                24,
                27,
                28,
                44,
                45,
                46,
                47,
                48,
                49,
                50,
                53,
                54,
                55,
                62,
                72,
                74,
                77,
                80,
                81,
                87,
                89,
                90,
                93,
                96,
                98,
                121,
                123,
                124,
                127,
                130,
                132,
            },

        # "middle_vertices" : done below

        # "front_vertices" : done below

        "back_vertices" :
            {
                0,
                3,
                4,
                6,
                7,
                8,
                12,
                13,
                17,
                19,
                22,
                25,
                26,
                29,
                39,
                40,
                41,
                45,
                46,
                50,
                71,
                72,
                73,
                74,
                75,
                77,
                78,
                81,
                89,
                92,
                123,
                126,
            },

        "top_vertices" :
            {
                0,
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                12,
                13,
                17,
                18,
                19,
                22,
                24,
                25,
                26,
                29,
                34,
                35,
                36,
                37,
                42,
                44,
                47,
                48,
                51,
                52,
                53,
                54,
                55,
                56,
                57,
                58,
                59,
                60,
                61,
                62,
                63,
                64,
                65,
                66,
                67,
                68,
                69,
                70,
                82,
                83,
                84,
                85,
                86,
                87,
                88,
                89,
                90,
                91,
                92,
                93,
                94,
                95,
                96,
                97,
                98,
                99,
                100,
                101,
                102,
                103,
            },

        # "bottom_vertices" : done below

    }
book_mesh["bounds"] = \
    (
        (min(v[0] for v in book_mesh["vertices"]), max(v[0] for v in book_mesh["vertices"])),
        (min(v[1] for v in book_mesh["vertices"]), max(v[1] for v in book_mesh["vertices"])),
        (min(v[2] for v in book_mesh["vertices"]), max(v[2] for v in book_mesh["vertices"])),
    )
print("book_mesh[\"bounds\"] = %s" % repr(book_mesh["bounds"])) # debug
book_mesh["middle_vertices"] = \
    (
        set(range(len(book_mesh["vertices"])))
    -
        book_mesh["left_vertices"]
    -
        book_mesh["right_vertices"]
    )
book_mesh["front_vertices"] = \
    set(range(len(book_mesh["vertices"]))) - book_mesh["back_vertices"]
  # everything that isn’t a back vertex
book_mesh["bottom_vertices"] = \
    set(range(len(book_mesh["vertices"]))) - book_mesh["top_vertices"]
  # everything that isn’t a top vertex

#+
# Mainline
#-

dimension_min = 0.001
dimension_default = 0.1

class Bookmaker(bpy.types.Operator) :
    bl_idname = "add_mesh.bookmaker"
    bl_label = "Bookmaker"
    bl_context = "objectmode"
    bl_options = {"REGISTER", "UNDO"}

    count = bpy.props.IntProperty \
      (
        name = "count",
        description = "How many books to generate",
        min = 1,
        default = 1,
      )
    width = bpy.props.FloatProperty \
      (
        name = "width",
        description = "base width of one book",
        min = dimension_min,
        default = dimension_default,
      )
    depth = bpy.props.FloatProperty \
      (
        name = "depth",
        description = "base depth of one book",
        min = dimension_min,
        default = dimension_default,
      )
    height = bpy.props.FloatProperty \
      (
        name = "height",
        description = "base height of one book",
        min = dimension_min,
        default = dimension_default,
      )

    def draw(self, context) :
        the_col = self.layout.column(align = True)
        the_col.prop(self, "count")
        the_col.prop(self, "width")
        the_col.prop(self, "depth")
        the_col.prop(self, "height")
    #end draw

    def action_common(self, context, redoing) :
        try :
            pos = context.scene.cursor_location
            vertices = []
            bounds = book_mesh["bounds"]
            for i in range(len(book_mesh["vertices"])) :
                coords = list(book_mesh["vertices"][i])
                coords[0] -= bounds[0][0]
                coords[1] -= bounds[1][0]
                coords[2] -= bounds[2][0]
                if i in book_mesh["middle_vertices"] :
                    coords[0] *= self.width / (bounds[0][1] - bounds[0][0])
                elif i in book_mesh["right_vertices"] :
                    coords[0] += self.width - (bounds[0][1] - bounds[0][0])
                #end if
                if i in book_mesh["back_vertices"] :
                    coords[1] += self.depth - (bounds[1][1] - bounds[1][0])
                #end if
                if i in book_mesh["top_vertices"] :
                    coords[2] += self.height - (bounds[2][1] - bounds[2][0])
                #end if
                vertices.append(coords)
            #end for
            new_mesh_name = new_obj_name = "Book"
            new_mesh = bpy.data.meshes.new(new_mesh_name)
            new_mesh.from_pydata(vertices, [], book_mesh["faces"])
            new_obj = bpy.data.objects.new(new_mesh_name, new_mesh)
            context.scene.objects.link(new_obj)
            bpy.ops.object.select_all(action = "DESELECT")
            bpy.data.objects[new_obj_name].select = True
            context.scene.objects.active = new_obj
            for this_vertex in new_mesh.vertices :
                this_vertex.select = True # usual Blender default for newly-created object
            #end for
            # TBD count
            # TBD materials
            # all done
            status = {"FINISHED"}
        except Failure as why :
            sys.stderr.write("Failure: %s\n" % why.msg) # debug
            self.report({"ERROR"}, why.msg)
            status = {"CANCELLED"}
        #end try
        return \
            status
    #end action_common

    def execute(self, context) :
        return \
            self.action_common(context, True)
    #end execute

    def invoke(self, context, event) :
        return \
            self.action_common(context, False)
    #end invoke

#end Bookmaker

def add_invoke_item(self, context) :
    self.layout.operator(Bookmaker.bl_idname, text = "Books")
#end add_invoke_item

def register() :
    bpy.utils.register_module(__name__)
    bpy.types.INFO_MT_mesh_add.append(add_invoke_item)
#end register

def unregister() :
    bpy.utils.unregister_module(__name__)
    bpy.types.INFO_MT_mesh_add.remove(add_invoke_item)
#end unregister

if __name__ == "__main__" :
    register()
#end if
